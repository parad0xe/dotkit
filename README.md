# Dotkit: Modular Environment Manager

Modular environment manager written in Bash. This tool automates the installation, configuration, and maintenance of a workspace, adapting to the presence or absence of administrator (sudo) rights on the target machine.

## Table of Contents

- [Features](#features)
- [Compatibility](#compatibility)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Project Structure](#project-structure)
- [Security & Backups](#security--backups)
- [Unprivileged Mode (Junest)](#unprivileged-mode-junest)
- [Modules API](#modules-api)
- [Tutorial: Creating a Module](#tutorial-creating-a-module)
- [Variables & Utilities](#variables--utilities)
- [Module Example](#module-example)

## Features

- Unprivileged execution: Installation of system dependencies in an isolated environment (via Junest) in the absence of `sudo` rights.
- Dynamic installation: Detection of the Linux distribution and selection of the appropriate package manager to deploy prerequisites.
- Shell management: Support for native installation and configuration of Bash, Zsh, and Fish.
- Automatic launch: Modification of the default source file to automatically switch to the selected shell upon session startup.
- Modular architecture: Segmentation into autonomous and sequential scripts, making it easy to add or remove tools without impacting the global environment.
- Preventive backups: Systematic backup and timestamping of existing configuration files before any writing or symlink creation.

## Compatibility

| Distribution                 | Package Manager |
|------------------------------|-----------------|
| Debian / Ubuntu (and derivs) | apt             |
| Arch Linux (and derivs)      | pacman          |

## Prerequisites

- Operating system based on Debian/Ubuntu or Arch Linux.
- Git installed and accessible in the PATH.

## Installation

Clone the repository into your home directory and execute the main script:

```bash
git clone https://github.com/parad0xe/dotkit ~/.dotkit
cd ~/.dotkit
./setup.sh install
```

## Usage

The `setup.sh` script manages operations. It accepts a main command followed by options.

```bash
./setup.sh [OPTIONS] <COMMAND>
```

### Available Commands

| Command       | Description                                                                                   |
|---------------|-----------------------------------------------------------------------------------------------|
| install       | Resolves dependencies, installs packages, and configures active modules.                      |
| reinstall     | Executes uninstallation routines before performing a clean installation.                      |
| reconfigure   | Updates symlinks and configurations (skips package installation).                             |
| uninstall     | Removes tools installed by the modules and cleans up shell initialization.                    |

### Command-Line Options

| Option        | Description                                                                                   |
|---------------|-----------------------------------------------------------------------------------------------|
| -y, --yes     | Non-interactive mode (automatically accepts prompts).                                         |
| -d, --dry-run | Simulation mode (displays actions without modifying the system).                              |
| -s, --shell   | Forces a specific target shell (e.g., -s zsh).                                                |
| -v, --verbose | Detailed output for debugging.                                                                |
| -h, --help    | Displays help and arguments.                                                                  |

## Project Structure

```text
.
├── assets/         # Static configuration files (text files, JSON, Lua, etc.)
├── lib/
│   └── core/       # Internal scripts (utility functions: UI, system, files)
├── modules/        # Isolated installation scripts (e.g., 01_system.sh, 20_editor.sh)
└── setup.sh        # Main entry point
```

## Security & Backups

- Installation mechanism: No existing user file is overwritten. Any file replaced by a symlink is moved and timestamped in the `~/.local/state/dotkit_backups/` directory.
- Uninstallation mechanism: The `uninstall` command only removes links and directories generated by the tool. Backups are not restored automatically (manual restoration required).

## Unprivileged Mode (Junest)

Designed for restricted environments (corporate servers, shared environments) without `root` or `sudo` access.

In the absence of `sudo` privileges, the `00_junest.sh` module is activated. Junest deploys an isolated Arch Linux subsystem in the user space. This allows using the `pacman` manager to install dependencies without an administrator password. Executables are automatically added to the `PATH`.

If valid `sudo` access is detected, this module is ignored in favor of the OS's native package manager.

## Modules API

The architecture relies on independent Bash scripts executed sequentially. The order is defined by the numeric prefix (e.g., `01_` before `10_`). Static files must be placed in the `assets/` directory and manipulated via the `$ASSETS_DIR` global variable.

### Required Functions

| Function             | Role                                                                                           |
|----------------------|------------------------------------------------------------------------------------------------|
| module_check()       | State evaluation (returns `$RET_MODULE_DOEXECUTE` or `$RET_MODULE_DONOTHING`).                 |
| module_install()     | Installation logic (recommended use of `pkg_install` or `safe_execute`).                       |
| module_configure()   | Configuration logic: folder creation (`safe_mkdir`) and symlinking (`safe_link`).              |
| module_uninstall()   | Removal of executables and links generated by the module.                                      |

### Optional Functions

| Function              | Role                                                                                          |
|-----------------------|-----------------------------------------------------------------------------------------------|
| module_enable()       | Module activation condition (returns `$RET_MODULE_DISABLE` to ignore the module).             |
| module_export_env()   | Injection of environment variables (e.g., PATH) persistent during execution.                  |

## Tutorial: Creating a Module

Example of integrating a simple configuration file for vim.

1. Directory creation and adding the static file:
```bash
mkdir -p assets/custom
echo 'syntax on' > assets/custom/.vimrc
```

2. Creating the executable file `modules/40_vim.sh` and implementing the API:
```bash
#!/bin/bash

module_check() {
    # Verification of file presence before action
    if ! file_exists "$HOME/.vimrc"; then
        return $RET_MODULE_DOEXECUTE
    fi
    return $RET_MODULE_DONOTHING
}

module_install() {
    # Package installation via the system manager
    pkg_install --both vim
}

module_configure() {
    # Creation of the symbolic link
    safe_link "$ASSETS_DIR/custom/.vimrc" "$HOME/.vimrc"
}

module_uninstall() {
    # Link removal during uninstallation
    safe_rm "$HOME/.vimrc"
}
```

3. Executing the main script:
```bash
./setup.sh install
```

## Variables & Utilities

### Global Variables

| Variable                         | Description                                                                    |
|----------------------------------|--------------------------------------------------------------------------------|
| $PROJECT_ROOT_DIR                | Absolute path to the manager's root directory.                                 |
| $ASSETS_DIR                      | Absolute path to the directory containing configuration files.                 |
| $TMP_DIR                         | Path to a temporary directory (purged at the end of execution).                |
| $LOCAL_BIN_DIR                   | Shortcut to `~/.local/bin`.                                                    |
| $LOCAL_FONT_DIR                  | Shortcut to `~/.local/share/fonts`.                                            |
| $BACKUP_DIR                      | Path to the directory of backed-up old configurations.                         |
| $TARGET_SHELL / $TARGET_SHELL_RC | Selected shell name and path to its startup file (RC).                         |

### Package Management

| Command                                | Action                                                                 |
|----------------------------------------|------------------------------------------------------------------------|
| pkg_install --both <package>           | Package installation on Debian AND Arch Linux.                         |
| pkg_install --debian-only <package>    | Package installation on Debian/Ubuntu only.                            |
| pkg_install --arch-only <package>      | Package installation on Arch Linux only.                               |
| npm_install_g <package>                | Global installation of a module via Node.js (NPM).                     |

### Core Utilities

| Category                 | Available Functions                                                                        |
|--------------------------|--------------------------------------------------------------------------------------------|
| Execution & Files        | safe_execute, safe_mkdir, safe_link, safe_rm, backup_file, ensure_has_command              |
| Condition Tests          | command_exists, fish_command_exists, file_exists, non_empty_file                           |
| Interface (UI) & Logs    | header, step, info, success, warn, fatal, muted, blank, confirm                            |

## Module Example

Module example (`modules/30_ssh.sh`) illustrating the generation of an SSH key:

```bash
#!/bin/bash

module_export_env() {
    # Export of the SSH_DIR variable
    printf '%s=%s\n' "SSH_DIR" "$TMP_DIR/.ssh"
}

module_enable() {
    # Deactivation of the module if the executable is not found
    if ! command_exists "ssh-keygen"; then
        return $RET_MODULE_DISABLE
    fi
    return $RET_MODULE_ENABLE
}

module_check() {
    # Triggering installation if the key does not exist
    if ! file_exists "$SSH_DIR/id_rsa"; then
        return $RET_MODULE_DOEXECUTE
    fi
    return $RET_MODULE_DONOTHING
}

module_install() {
    header "SSH Key Generation"

    step "Creating the key pair in $SSH_DIR..."
    safe_mkdir "$SSH_DIR"
    safe_execute ssh-keygen -t rsa -b 4096 -f "$SSH_DIR/id_rsa"

    success "SSH key generated"
}

module_configure() {
    muted "No additional configuration required."
}

module_uninstall() {
    warn "The SSH directory is ignored during uninstallation."
    return $RETOK
}
```

## License & Support

Source code distributed under the MIT License (free to use, modify, and distribute).

To report a bug or suggest an improvement: open an Issue on the project's Git repository.
